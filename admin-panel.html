<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGK Cloud Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; }
        .tab-btn.active { background: #22d3ee; color: black; font-weight: bold; }
        input, select, textarea { background: #1e293b; border: 1px solid #334155; padding: 8px; border-radius: 6px; width: 100%; color: white; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        input[type="checkbox"] { width: 16px; height: 16px; accent-color: #22d3ee; cursor: pointer; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .cursor-crosshair { cursor: crosshair; }
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body class="p-6">

    <div id="auth-modal" class="fixed inset-0 z-[3000] bg-black flex items-center justify-center p-4">
        <div class="glass p-8 rounded-xl w-full max-w-sm text-center border border-gray-800 shadow-2xl">
            <div class="w-16 h-16 bg-cyan-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-lock text-2xl text-cyan-400"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-white">Admin Access</h2>
            <p class="text-gray-400 text-sm mb-6">Login to manage SGK Cloud Data</p>
            
            <input type="email" id="admin-email" placeholder="admin@sgk.com" class="mb-4 bg-black/50 border-gray-700 focus:border-cyan-500 outline-none">
            <input type="password" id="admin-pass" placeholder="Password" class="mb-6 bg-black/50 border-gray-700 focus:border-cyan-500 outline-none">
            
            <button onclick="adminLogin()" class="w-full bg-cyan-500 text-black font-bold py-3 rounded hover:bg-cyan-400 transition shadow-[0_0_20px_rgba(6,182,212,0.3)]">
                LOGIN TO DASHBOARD
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-4 font-bold"></p>
        </div>
    </div>

    <div id="app-ui" class="max-w-7xl mx-auto hidden">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-cyan-400 flex items-center gap-3">
                <i class="fas fa-cloud"></i> SGK Cloud Panel
            </h1>
            
            <div class="flex gap-4 items-center">
                <div id="data-status" class="px-4 py-2 rounded-lg bg-green-500/20 text-green-400 border border-green-500/50 font-bold text-xs flex items-center gap-2">
                    <i class="fas fa-wifi"></i> CONNECTED
                </div>

                <button onclick="saveToCloud()" id="save-btn" class="bg-green-500 hover:bg-green-600 text-black font-bold py-3 px-6 rounded-lg shadow-[0_0_20px_rgba(34,197,94,0.5)] transition hover:scale-105 active:scale-95 flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt"></i> SAVE CHANGES
                </button>
                
                <button onclick="firebase.auth().signOut()" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-4 py-3 rounded-lg border border-red-500/30 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="flex gap-2 mb-6 border-b border-gray-700 pb-2 overflow-x-auto">
            <button onclick="switchTab('status')" id="tab-status" class="tab-btn active px-4 py-2 rounded-t-lg transition whitespace-nowrap">üì° Network Status</button>
            <button onclick="switchTab('plans')" id="tab-plans" class="tab-btn px-4 py-2 rounded-t-lg transition whitespace-nowrap">üí∞ Plans & Prices</button>
            <button onclick="switchTab('map')" id="tab-map" class="tab-btn px-4 py-2 rounded-t-lg transition whitespace-nowrap">üó∫Ô∏è Map & Coverage</button>
            <button onclick="switchTab('footer')" id="tab-footer" class="tab-btn px-4 py-2 rounded-t-lg transition whitespace-nowrap">üìù Footer & Socials</button>
        </div>

        <div id="view-status" class="view-section">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 text-purple-400">General Settings</h2>
                    <div class="space-y-4">
                        <div><label class="text-xs text-gray-400">Company Name</label><input type="text" id="conf-name"></div>
                        <div><label class="text-xs text-gray-400">Phone Number</label><input type="text" id="conf-phone"></div>
                        <div><label class="text-xs text-gray-400">UPI ID</label><input type="text" id="conf-upi"></div>
                        <div><label class="text-xs text-gray-400">Service Cities (Comma Separated)</label><input type="text" id="conf-area" placeholder="e.g. Dombivli, Thane, Kalyan"></div>
                    </div>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-l-red-500">
                    <h2 class="text-xl font-bold mb-4 text-red-400">Emergency Controls</h2>
                    <div id="zone-list-status" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="view-plans" class="view-section hidden">
            <button onclick="addNewPlan()" class="w-full py-4 mb-6 rounded-xl border-2 border-dashed border-cyan-500/30 text-cyan-400 font-bold hover:bg-cyan-500/10 hover:border-cyan-400 transition">
                <i class="fas fa-plus-circle"></i> ADD NEW PLAN
            </button>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="plans-editor-container"></div>
        </div>

        <div id="view-map" class="view-section hidden">
            <div class="flex gap-4 h-[600px]">
                <div class="w-1/4 glass p-4 rounded-xl flex flex-col">
                    <h3 class="font-bold mb-2">Zone Manager</h3>
                    <div id="drawing-mode-indicator" class="hidden mb-3 bg-yellow-500/20 border border-yellow-500/50 p-3 rounded text-xs text-yellow-200">
                        <div class="font-bold flex items-center gap-2 mb-1"><i class="fas fa-pencil-alt"></i> EDITING MODE</div>
                        <ul class="list-disc pl-4 opacity-80 space-y-1">
                            <li><strong>Gray Zones:</strong> Existing</li>
                            <li><strong>Yellow Zone:</strong> Editing</li>
                            <li><strong>Right-Click</strong> dot to delete</li>
                        </ul>
                    </div>
                    <div id="map-zone-list" class="flex-1 overflow-y-auto space-y-2 mb-4 custom-scroll pr-2"></div>
                    <button id="add-zone-btn" onclick="startNewZone()" class="mt-2 w-full bg-cyan-500 text-black font-bold py-2 rounded hover:bg-cyan-400 shadow-lg">+ Add New Zone</button>
                    <button id="cancel-draw-btn" onclick="cancelDrawing()" class="hidden mt-2 w-full bg-gray-600 text-white font-bold py-2 rounded hover:bg-gray-500">Cancel</button>
                </div>
                <div class="w-3/4 relative rounded-xl overflow-hidden border border-gray-700 bg-gray-900 group">
                    <div id="admin-map" class="h-full w-full bg-gray-900 z-0"></div>
                    <button id="finish-poly-btn" onclick="finishPolygon()" class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 z-[1000] bg-green-500 hover:bg-green-400 text-black font-bold px-8 py-3 rounded-full shadow-[0_0_20px_rgba(34,197,94,0.5)] transition transform hover:scale-105 flex items-center gap-2"><i class="fas fa-check"></i> SAVE ZONE</button>
                </div>
            </div>
        </div>

        <div id="view-footer" class="view-section hidden">
            <div class="glass p-8 rounded-xl max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-cyan-400"><i class="fas fa-info-circle"></i> Footer & Contact Details</h2>
                <div class="space-y-6">
                    <div><label class="block text-sm text-gray-400 mb-2">About Us Description</label><textarea id="foot-about" rows="3" class="w-full bg-black/20 border border-gray-600 rounded p-3 text-sm"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm text-gray-400 mb-2">Email</label><input type="text" id="foot-email"></div>
                        <div><label class="block text-sm text-gray-400 mb-2">Address</label><input type="text" id="foot-address"></div>
                    </div>
                    <div class="border-t border-gray-700 pt-6">
                        <h3 class="text-lg font-bold mb-4 text-pink-400">Social Links</h3>
                        <p class="text-xs text-gray-500 mb-4">Empty links will be hidden.</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3"><i class="fab fa-facebook text-blue-500 w-6"></i><input type="text" id="foot-fb" placeholder="Facebook URL"></div>
                            <div class="flex items-center gap-3"><i class="fab fa-instagram text-pink-500 w-6"></i><input type="text" id="foot-insta" placeholder="Instagram URL"></div>
                            <div class="flex items-center gap-3"><i class="fab fa-twitter text-blue-400 w-6"></i><input type="text" id="foot-tw" placeholder="Twitter URL"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="zone-modal" class="fixed inset-0 bg-black/80 z-[2000] hidden flex items-center justify-center p-4">
        <div class="glass p-6 rounded-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Create New Zone</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 uppercase">Select City</label>
                    <select id="new-zone-city" class="w-full bg-black/30 border border-cyan-500/50 rounded p-2 text-white"></select>
                </div>
                <div>
                    <label class="text-xs text-gray-400 uppercase">Zone Name</label>
                    <input type="text" id="new-zone-name" class="w-full bg-black/30 border border-cyan-500/50 rounded p-2 text-white" placeholder="e.g. Cluster 4">
                </div>
                <button onclick="confirmZoneCreation()" class="w-full bg-cyan-500 text-black font-bold py-3 rounded hover:bg-cyan-400">SAVE ZONE</button>
                <button onclick="document.getElementById('zone-modal').classList.add('hidden')" class="w-full bg-gray-600 text-white font-bold py-2 rounded hover:bg-gray-500 mt-2">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. FIREBASE CONFIGURATION (REPLACE THESE!)
        // ==========================================
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAO_1qoKmeXzyhB5YKlg4R3oQ4IRXudvCE",
  authDomain: "sgk-isp-website.firebaseapp.com",
  projectId: "sgk-isp-website",
  storageBucket: "sgk-isp-website.firebasestorage.app",
  messagingSenderId: "653091870065",
  appId: "1:653091870065:web:5fc8739eb6d9af029352d0",
  measurementId: "G-8L5198RZQJ"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==========================================
        // 2. GLOBAL VARIABLES
        // ==========================================
        let data = { config:{}, plans:[], zones:[], footer:{} }; 
        let map, drawLayer;
        let tempPoints = [], isDrawing = false, editingIndex = null; 

        // ==========================================
        // 3. AUTHENTICATION LOGIC
        // ==========================================
        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('app-ui').classList.remove('hidden');
                loadFromCloud(); // Start App
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('app-ui').classList.add('hidden');
            }
        });

        function adminLogin() {
            const e = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-pass').value;
            const errEl = document.getElementById('login-error');
            
            if(!e || !p) { errEl.innerText = "Please enter email and password"; return; }
            errEl.innerText = "Authenticating...";

            auth.signInWithEmailAndPassword(e, p).catch(err => {
                errEl.innerText = "Error: " + err.message;
            });
        }

        // ==========================================
        // 4. CLOUD SAVE / LOAD
        // ==========================================
        async function loadFromCloud() {
            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> LOADING...';
            
            try {
                const doc = await db.collection('settings').doc('siteData').get();
                if (doc.exists) {
                    data = doc.data();
                } else {
                    console.log("No data found, initializing default structure...");
                    data = { 
                        config: { name: "SGK NET", phone: "", upiId: "", areaName: "" },
                        footer: {}, plans: [], zones: []
                    }; 
                }
                
                // Auto-Fixes for old data structures
                if(!data.zones) data.zones = [];
                if(!data.plans) data.plans = [];
                data.plans.forEach(p => { 
                    if(!p.linkedZones) p.linkedZones = ["All"]; 
                    if(!p.installation) p.installation = { "1 Month": 1000, "LongTerm": 500 }; 
                });

                populateUI();
                initAdminMap();
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> SAVE CHANGES';
            } catch (error) {
                alert("Critical Error Loading Data: " + error.message);
            }
        }

        async function saveToCloud() {
            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> SAVING...';
            
            scrapeDataFromUI(); // Gather latest inputs

            try {
                await db.collection('settings').doc('siteData').set(data);
                btn.innerHTML = '<i class="fas fa-check"></i> SAVED!';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> SAVE CHANGES', 2000);
            } catch (error) {
                alert("Save Failed: " + error.message);
                btn.innerHTML = 'ERROR';
            }
        }

        function scrapeDataFromUI() {
            data.config.name = document.getElementById('conf-name').value;
            data.config.phone = document.getElementById('conf-phone').value;
            data.config.upiId = document.getElementById('conf-upi').value;
            data.config.areaName = document.getElementById('conf-area').value;
            data.config.address = document.getElementById('foot-address').value;
            data.config.whatsapp = document.getElementById('conf-phone').value;
            data.footer = {
                about: document.getElementById('foot-about').value,
                email: document.getElementById('foot-email').value,
                facebook: document.getElementById('foot-fb').value,
                instagram: document.getElementById('foot-insta').value,
                twitter: document.getElementById('foot-tw').value
            };
            // Clean up empty features in plans
            data.plans.forEach(p => {
                if(p.features) p.features = p.features.filter(f => f && f.trim() !== '');
            });
        }

        function populateUI() {
            document.getElementById('conf-name').value = data.config.name || "";
            document.getElementById('conf-phone').value = data.config.phone || "";
            document.getElementById('conf-upi').value = data.config.upiId || "";
            document.getElementById('conf-area').value = data.config.areaName || "";

            if(!data.footer) data.footer = {};
            document.getElementById('foot-about').value = data.footer.about || "";
            document.getElementById('foot-email').value = data.footer.email || "";
            document.getElementById('foot-address').value = data.config.address || "";
            document.getElementById('foot-fb').value = data.footer.facebook || "";
            document.getElementById('foot-insta').value = data.footer.instagram || "";
            document.getElementById('foot-tw').value = data.footer.twitter || "";

            renderStatusZones();
            renderPlans();
        }

        // ==========================================
        // 5. UI TABS & STATUS LOGIC
        // ==========================================
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            if(tab === 'map' && map) setTimeout(() => map.invalidateSize(), 200);
        }

        function renderStatusZones() {
            const container = document.getElementById('zone-list-status');
            container.innerHTML = '';
            const cities = [...new Set(data.zones.map(z => z.city))];
            
            cities.forEach(city => {
                container.innerHTML += `<div class="text-xs font-bold text-gray-500 uppercase mt-4 mb-2 border-b border-gray-700 pb-1">${city || "Unknown City"}</div>`;
                data.zones.forEach((zone, idx) => {
                    if(zone.city !== city) return;
                    const isDown = zone.status === 'down';
                    container.innerHTML += `
                        <div class="bg-black/30 p-3 rounded border ${isDown ? 'border-red-500' : 'border-green-500'} mb-2">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-sm">${zone.name}</span>
                                <select onchange="updateZoneStatus(${idx}, this.value)" class="text-xs w-24 ${isDown?'bg-red-900':'bg-green-900'}">
                                    <option value="online" ${!isDown?'selected':''}>Online</option>
                                    <option value="down" ${isDown?'selected':''}>Outage</option>
                                </select>
                            </div>
                            ${isDown ? `
                                <div class="space-y-2 mt-2">
                                    <input type="text" placeholder="Issue" value="${zone.issue||''}" oninput="data.zones[${idx}].issue=this.value" class="text-xs w-full bg-black/20 border border-gray-600 rounded px-2 py-1">
                                    <div class="flex gap-2">
                                        <input type="time" id="time-${idx}" class="text-xs bg-black/20 border border-gray-600 rounded w-2/3 text-white" onchange="updateZoneEta(${idx})">
                                        <select id="day-${idx}" class="text-xs bg-black/20 border border-gray-600 rounded w-1/3 text-white" onchange="updateZoneEta(${idx})">
                                            <option value="Today">Today</option><option value="Tomorrow">Tomorrow</option>
                                        </select>
                                    </div>
                                    <div class="text-[9px] text-cyan-400 text-right">${zone.eta || ''}</div>
                                </div>` : ''}
                        </div>`;
                });
            });
        }
        function updateZoneStatus(idx, s) { 
            data.zones[idx].status = s; 
            if(s==='down') data.zones[idx].color='#ef4444'; else { data.zones[idx].color='#06b6d4'; data.zones[idx].eta=''; }
            renderStatusZones(); renderMapZones();
        }
        function updateZoneEta(idx) {
            const t = document.getElementById(`time-${idx}`).value; 
            const d = document.getElementById(`day-${idx}`).value;
            if(t) { const [h,m] = t.split(':'); let H=parseInt(h), ap=H>=12?'PM':'AM'; H=H%12||12; data.zones[idx].eta=`${H}:${m} ${ap} ${d}`; }
            renderStatusZones();
        }

        // ==========================================
        // 6. PLANS EDITOR
        // ==========================================
        function renderPlans() {
            const container = document.getElementById('plans-editor-container');
            container.innerHTML = '';
            const cities = data.config.areaName ? data.config.areaName.split(',').map(s => s.trim()) : [];

            data.plans.forEach((plan, idx) => {
                if(!plan.features) plan.features = [];
                if(!plan.installation) plan.installation = { "1 Month": 1000, "LongTerm": 500 };

                let html = `<div class="glass p-4 rounded-xl border border-gray-700 hover:border-cyan-500 relative group">
                    <button onclick="deletePlan(${idx})" class="absolute top-2 right-2 text-red-500 hover:bg-red-500 hover:text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-trash"></i></button>
                    <input type="text" value="${plan.name}" oninput="data.plans[${idx}].name=this.value" class="font-bold text-lg mb-2 bg-transparent border-b border-gray-700 focus:border-cyan-500 w-full" placeholder="Plan Name">
                    
                    <div class="flex gap-2 mb-3">
                        <input type="text" value="${plan.speed}" oninput="data.plans[${idx}].speed=this.value" class="text-sm bg-black/20 w-20 border-b border-gray-700" placeholder="Speed">
                        <label class="text-xs flex items-center gap-1"><input type="checkbox" ${plan.highlight?'checked':''} onchange="data.plans[${idx}].highlight=this.checked"> Highlight</label>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-xs mb-3 bg-black/20 p-2 rounded">
                        <div>1M: <input type="number" value="${plan.rates['1 Month']}" oninput="data.plans[${idx}].rates['1 Month']=this.value" class="w-12 bg-transparent border-b border-gray-600"></div>
                        <div>3M: <input type="number" value="${plan.rates['3 Months']}" oninput="data.plans[${idx}].rates['3 Months']=this.value" class="w-12 bg-transparent border-b border-gray-600"></div>
                        <div>6M: <input type="number" value="${plan.rates['6 Months']}" oninput="data.plans[${idx}].rates['6 Months']=this.value" class="w-12 bg-transparent border-b border-gray-600"></div>
                        <div>1Y: <input type="number" value="${plan.rates['1 Year']}" oninput="data.plans[${idx}].rates['1 Year']=this.value" class="w-12 bg-transparent border-b border-gray-600"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-xs mb-3 bg-purple-900/20 p-2 rounded border border-purple-500/30">
                        <div>Install (1M): <input type="number" value="${plan.installation['1 Month']}" oninput="data.plans[${idx}].installation['1 Month']=this.value" class="w-12 bg-transparent border-b border-purple-400"></div>
                        <div>Install (Long): <input type="number" value="${plan.installation['LongTerm']}" oninput="data.plans[${idx}].installation['LongTerm']=this.value" class="w-12 bg-transparent border-b border-purple-400"></div>
                    </div>

                    <div class="mb-3">
                        <p class="text-[9px] text-gray-500 font-bold uppercase mb-1">Features (Max 3)</p>
                        <div class="space-y-1">
                            <input type="text" value="${plan.features[0]||''}" oninput="updateFeature(${idx}, 0, this.value)" class="text-xs bg-black/20 w-full border-b border-gray-700 p-1" placeholder="Feature 1">
                            <input type="text" value="${plan.features[1]||''}" oninput="updateFeature(${idx}, 1, this.value)" class="text-xs bg-black/20 w-full border-b border-gray-700 p-1" placeholder="Feature 2">
                            <input type="text" value="${plan.features[2]||''}" oninput="updateFeature(${idx}, 2, this.value)" class="text-xs bg-black/20 w-full border-b border-gray-700 p-1" placeholder="Feature 3">
                        </div>
                    </div>

                    <div class="h-32 overflow-y-auto custom-scroll bg-black/20 p-2 rounded border border-gray-700">
                        <div class="mb-2">
                            <label class="flex items-center gap-2 text-xs font-bold text-cyan-400 bg-cyan-900/20 p-1 rounded mb-1">
                                <input type="checkbox" ${plan.linkedZones.includes("All")?'checked':''} onchange="togglePlanZone(${idx}, 'All')"> ALL CITIES (GLOBAL)
                            </label>
                        </div>
                        ${cities.map(city => {
                            const cityZones = data.zones.filter(z => z.city === city);
                            let zoneList = cityZones.map(z => 
                                `<label class="flex items-center gap-2 text-xs pl-4 py-0.5 text-gray-400 hover:text-white">
                                    <input type="checkbox" ${plan.linkedZones.includes(z.name)?'checked':''} onchange="togglePlanZone(${idx}, '${z.name}')"> üè† ${z.name}
                                </label>`
                            ).join('');
                            return `
                                <div class="mb-2">
                                    <label class="flex items-center gap-2 text-xs font-bold text-white bg-gray-800 p-1 rounded">
                                        <input type="checkbox" ${plan.linkedZones.includes(city)?'checked':''} onchange="togglePlanZone(${idx}, '${city}')"> üìç ${city} (Entire City)
                                    </label>
                                    ${zoneList}
                                </div>`;
                        }).join('')}
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }
        function togglePlanZone(idx, val) { 
            let z = data.plans[idx].linkedZones; 
            z.includes(val) ? z=z.filter(x=>x!==val) : z.push(val); 
            data.plans[idx].linkedZones=z; renderPlans(); 
        }
        function updateFeature(planIdx, featureIdx, val) {
            if(!data.plans[planIdx].features) data.plans[planIdx].features = [];
            data.plans[planIdx].features[featureIdx] = val;
        }
        function addNewPlan() { 
            data.plans.push({ id:Date.now(), name:"NEW PLAN", speed:"50 Mbps", highlight:false, linkedZones:["All"], rates:{"1 Month":500,"3 Months":1500,"6 Months":3000,"1 Year":6000}, installation:{"1 Month":1000,"LongTerm":500}, features:["", "", ""] }); 
            renderPlans(); 
        }
        function deletePlan(idx) { if(confirm("Delete this plan?")) { data.plans.splice(idx,1); renderPlans(); } }

        // ==========================================
        // 7. MAP & DRAWING LOGIC
        // ==========================================
        function initAdminMap() {
            if(map) map.remove();
            // Default center if no zones exist
            const startCoords = (data.zones.length > 0 && data.zones[0].points.length > 0) ? data.zones[0].points[0] : [19.2183, 73.0878];
            map = L.map('admin-map').setView(startCoords, 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
            drawLayer = L.layerGroup().addTo(map);
            renderMapZones();
            map.on('click', e => { if(isDrawing){ tempPoints.push([e.latlng.lat, e.latlng.lng]); renderEditor(); } });
        }
        function renderMapZones() {
            if(isDrawing) return; drawLayer.clearLayers(); document.getElementById('map-zone-list').innerHTML = '';
            data.zones.forEach((z, i) => {
                const c = z.status==='down'?'#ef4444':'#06b6d4';
                L.polygon(z.points, {color:c, fillColor:c, fillOpacity:0.2}).addTo(drawLayer).bindTooltip(z.name, {permanent:true, direction:"center", className:"bg-transparent border-none text-white font-bold shadow-none"});
                document.getElementById('map-zone-list').innerHTML += `
                    <div class="bg-gray-800 p-2 rounded flex justify-between text-xs mb-1 border border-gray-700">
                        <div><span class="font-bold text-white">${z.name}</span> <span class="text-gray-500">(${z.city || 'No City'})</span></div>
                        <div class="flex gap-2"><button onclick="editZone(${i})" class="text-yellow-500"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteZone(${i})" class="text-red-500"><i class="fas fa-trash"></i></button></div>
                    </div>`;
            });
        }
        function startNewZone() { 
            isDrawing=true; editingIndex=null; tempPoints=[]; 
            document.getElementById('finish-poly-btn').classList.remove('hidden'); 
            toggleDrawingUI(true); renderEditor(); 
        }
        function editZone(idx) { 
            isDrawing=true; editingIndex=idx; tempPoints=JSON.parse(JSON.stringify(data.zones[idx].points)); 
            if(tempPoints.length>0) map.flyTo(tempPoints[0], 16); 
            document.getElementById('finish-poly-btn').innerHTML = '<i class="fas fa-save"></i> UPDATE'; 
            document.getElementById('finish-poly-btn').classList.remove('hidden');
            toggleDrawingUI(true); renderEditor(); 
        }
        function renderEditor() {
            drawLayer.clearLayers();
            data.zones.forEach((z, i) => { if(i!==editingIndex) L.polygon(z.points, {color:'#334155', fillOpacity:0.1, weight:1, dashArray:'5,5'}).addTo(drawLayer); });
            if(tempPoints.length>0) L.polygon(tempPoints, {color:'#eab308', weight:3}).addTo(drawLayer);
            tempPoints.forEach((p,i) => { 
                L.marker(p, {draggable:true, icon:L.divIcon({className:'bg-yellow-500 rounded-full border-2 border-white', iconSize:[12,12]})})
                .addTo(drawLayer).on('drag', e=>{ tempPoints[i]=[e.latlng.lat, e.latlng.lng]; }).on('dragend', ()=>renderEditor()).on('contextmenu', ()=>{ tempPoints.splice(i,1); renderEditor(); }); 
            });
        }
        function toggleDrawingUI(active) {
            document.getElementById('drawing-mode-indicator').classList.toggle('hidden', !active);
            document.getElementById('add-zone-btn').classList.toggle('hidden', active);
            document.getElementById('cancel-draw-btn').classList.toggle('hidden', !active);
        }
        function cancelDrawing() { isDrawing=false; editingIndex=null; tempPoints=[]; document.getElementById('finish-poly-btn').classList.add('hidden'); toggleDrawingUI(false); renderMapZones(); }
        
        function finishPolygon() {
            if(tempPoints.length<3) return alert("Min 3 points!");
            if(editingIndex!==null) {
                data.zones[editingIndex].points = tempPoints;
                cancelDrawing(); renderPlans(); renderStatusZones();
            } else {
                const select = document.getElementById('new-zone-city');
                select.innerHTML = '';
                const cities = document.getElementById('conf-area').value.split(',');
                cities.forEach(c => {
                    const opt = document.createElement('option'); opt.value=c.trim(); opt.innerText=c.trim(); select.appendChild(opt);
                });
                document.getElementById('zone-modal').classList.remove('hidden');
            }
        }
        function confirmZoneCreation() {
            const name = document.getElementById('new-zone-name').value;
            const city = document.getElementById('new-zone-city').value;
            if(!name) return alert("Enter Name");
            data.zones.push({ name: name, city: city, status: 'online', color: '#06b6d4', points: tempPoints });
            document.getElementById('zone-modal').classList.add('hidden');
            document.getElementById('new-zone-name').value = '';
            cancelDrawing(); renderPlans(); renderStatusZones();
        }
        function deleteZone(idx) { if(confirm("Delete zone?")) { data.zones.splice(idx,1); renderMapZones(); renderPlans(); renderStatusZones(); } }
    </script>
</body>
</html>
